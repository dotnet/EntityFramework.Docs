<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Testing with InMemory </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Testing with InMemory ">
    <meta name="generator" content="docfx 2.5.4.0">
    
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
  </head>
  <body data-spy="scroll" data-target="#affix">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="article row grid">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="miscellaneous/testing">
              <h1 id="testing-with-inmemory" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="4" sourceendlinenumber="4">Testing with InMemory</h1>
              
<div class="WARNING sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="6" sourceendlinenumber="6" "=""><h5>Warning</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="7" sourceendlinenumber="7">This documentation is for EF Core. For EF6.x and earlier release see <a href="http://msdn.com/data/ef" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="7" sourceendlinenumber="7"><a href="http://msdn.com/data/ef" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="7" sourceendlinenumber="7">http://msdn.com/data/ef</a></a>.</p>
</div>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="9" sourceendlinenumber="9">This article covers how to use the InMemory provider to write efficient tests with minimal impact to the code being tested.</p>
<div class="WARNING sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="11" sourceendlinenumber="11" "=""><h5>Warning</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="12" sourceendlinenumber="12">Currently you need to use <code>ServiceCollection</code> and <code>IServiceProvider</code> to control the scope of the InMemory database, which adds complexity to your tests. In the next release after RC2, there will be improvements to make this easier, <a href="https://github.com/aspnet/EntityFramework/issues/3253" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="12" sourceendlinenumber="12">see issue #3253</a> for more details.</p>
</div>
<div class="TIP sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="14" sourceendlinenumber="14" "=""><h5>Tip</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="15" sourceendlinenumber="15">You can view this article&#39;s <a href="https://github.com/aspnet/EntityFramework.Docs/tree/master/samples/Miscellaneous/Testing" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="15" sourceendlinenumber="15">sample</a> on GitHub.</p>
</div>
<h2 id="when-to-use-inmemory-for-testing" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="17" sourceendlinenumber="17">When to use InMemory for testing</h2>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="19" sourceendlinenumber="19">The InMemory provider is useful when you want to test components using something that approximates connecting to the real database, without the overhead of actual database operations.</p>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="21" sourceendlinenumber="21">For example, consider the following service that allows application code to perform some operations related to blogs. Internally it uses a <code>DbContext</code> that connects to a SQL Server database. It would be useful to swap this context to connect to an InMemory database so that we can write efficient tests for this service without having to modify the code, or do a lot of work to create a test double of the context.</p>
<!-- [!code-csharp[Main](samples/Miscellaneous/Testing/BusinessLogic/BlogService.cs)] -->
<pre sourcefile="miscellaneous/testing.md" sourcestartlinenumber="24" sourceendlinenumber="49"><code class="lang-csharp">public class BlogService
{
    private BloggingContext _context;

    public BlogService(BloggingContext context)
    {
        _context = context;
    }

    public void Add(string url)
    {
        var blog = new Blog { Url = url };
        _context.Blogs.Add(blog);
        _context.SaveChanges();
    }

    public IEnumerable&lt;Blog&gt; Find(string term)
    {
        return _context.Blogs
            .Where(b =&gt; b.Url.Contains(term))
            .OrderBy(b =&gt; b.Url)
            .ToList();
    }
}
</code></pre><h3 id="inmemory-is-not-a-relational-database" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="51" sourceendlinenumber="51">InMemory is not a relational database</h3>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="53" sourceendlinenumber="53">EF Core database providers do not have to be relational databases. InMemory is designed to be a general purpose database for testing, and is not designed to mimic a relational database.</p>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="55" sourceendlinenumber="55">Some examples of this include:</p>
<ul sourcefile="miscellaneous/testing.md" sourcestartlinenumber="56" sourceendlinenumber="58">
<li sourcefile="miscellaneous/testing.md" sourcestartlinenumber="56" sourceendlinenumber="56"><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="56" sourceendlinenumber="56">InMemory will allow you to save data that would violate referential integrity constraints in a relational database.</p>
</li>
<li sourcefile="miscellaneous/testing.md" sourcestartlinenumber="58" sourceendlinenumber="58"><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="58" sourceendlinenumber="58">If you use DefaultValueSql(string) for a property in your model, this is a relational database API and will have no effect when running against InMemory.</p>
</li>
</ul>
<div class="TIP sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="60" sourceendlinenumber="60" "=""><h5>Tip</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="61" sourceendlinenumber="61">For many test purposes these difference will not matter. However, if you want to test against something that behaves more like a true relational database, then consider using <a href="http://www.sqlite.org/inmemorydb.html" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="61" sourceendlinenumber="61">SQLite in-memory mode</a>.</p>
</div>
<h2 id="get-your-context-ready" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="63" sourceendlinenumber="63">Get your context ready</h2>
<h3 id="avoid-configuring-two-database-providers" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="65" sourceendlinenumber="65">Avoid configuring two database providers</h3>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="67" sourceendlinenumber="67">In your tests you are going to externally configure the context to use the InMemory provider. If you are configuring a database provider by overriding <code>OnConfiguring</code> in your context, then you need to add some conditional code to ensure that you only configure the database provider if one has not already been configured.</p>
<div class="NOTE sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="69" sourceendlinenumber="69" "=""><h5>Note</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="70" sourceendlinenumber="70">If you are using ASP.NET Core, then you should not need this code since your database provider is configured outside of the context (in Startup.cs).</p>
</div>
<!-- [!code-csharp[Main](samples/Miscellaneous/Testing/BusinessLogic/BloggingContext.cs?highlight=3)] -->
<pre sourcefile="miscellaneous/testing.md" sourcestartlinenumber="73" sourceendlinenumber="80"><code class="lang-csharp"> protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
 {
     if (!optionsBuilder.IsConfigured)
     {
         optionsBuilder.UseSqlServer(@&quot;Server=(localdb)\mssqllocaldb;Database=EFProviders.InMemory;Trusted_Connection=True;&quot;);
     }
</code></pre><h3 id="add-a-constructor-for-testing" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="82" sourceendlinenumber="82">Add a constructor for testing</h3>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="84" sourceendlinenumber="84">The simplest way to enable testing with the InMemory provider is to modify your context to expose a constructor that accepts a <code>DbContextOptions&lt;TContext&gt;</code>.</p>
<!-- [!code-csharp[Main](samples/Miscellaneous/Testing/BusinessLogic/BloggingContext.cs?highlight=6,7,8)] -->
<pre sourcefile="miscellaneous/testing.md" sourcestartlinenumber="87" sourceendlinenumber="96"><code class="lang-csharp">public class BloggingContext : DbContext
{
    public BloggingContext()
    { }

    public BloggingContext(DbContextOptions&lt;BloggingContext&gt; options)
        : base(options)
    { }
</code></pre><div class="NOTE sourceFile=" miscellaneous/testing.md"="" sourcestartlinenumber="98" sourceendlinenumber="98" "=""><h5>Note</h5><p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="99" sourceendlinenumber="99"><code>DbContextOptions&lt;TContext&gt;</code> tells the context all of its settings, such as which database to connect to. This is the same object that is built by running the OnConfiguring method in your context.</p>
</div>
<h2 id="writing-tests" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="101" sourceendlinenumber="101">Writing tests</h2>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="103" sourceendlinenumber="103">The key to testing with this provider is the ability to tell the context to use the InMemory provider, and control the scope of the in-memory database. Typically you want a clean database for each test method.</p>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="105" sourceendlinenumber="105"><code>DbContextOptions&lt;TContext&gt;</code> exposes a <code>UseInternalServiceProvider</code> method that allows us to control the <code>IServiceProvider</code> the context will use. <code>IServiceProvider</code> is the container that EF will resolve all its services from (including the InMemory database instance). Typically, EF creates a single <code>IServiceProvider</code> for all contexts of a given type in an AppDomain - meaning all context instances share the same InMemory database instance. By allowing one to be passed in, you can control the scope of the InMemory database.</p>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="107" sourceendlinenumber="107">Here is an example of a test class that uses the InMemory database. Each test method creates a new <code>DbContextOptions&lt;TContext&gt;</code> with a new <code>IServiceProvider</code>, meaning each method has its own InMemory database.</p>
<!-- [!code-csharp[Main](samples/Miscellaneous/Testing/TestProject/BlogServiceTests.cs)] -->
<pre sourcefile="miscellaneous/testing.md" sourcestartlinenumber="110" sourceendlinenumber="186"><code class="lang-csharp">using BusinessLogic;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Linq;

namespace TestProject
{
    [TestClass]
    public class BlogServiceTests
    {
        private static DbContextOptions&lt;BloggingContext&gt; CreateNewContextOptions()
        {
            // Create a fresh service provider, and therefore a fresh 
            // InMemory database instance.
            var serviceProvider = new ServiceCollection()
                .AddEntityFrameworkInMemoryDatabase()
                .BuildServiceProvider();

            // Create a new options instance telling the context to use an
            // InMemory database and the new service provider.
            var builder = new DbContextOptionsBuilder&lt;BloggingContext&gt;();
            builder.UseInMemoryDatabase()
                   .UseInternalServiceProvider(serviceProvider);

            return builder.Options;
        }

        [TestMethod]
        public void Add_writes_to_database()
        {
            // All contexts that share the same service provider will share the same InMemory database
            var options = CreateNewContextOptions();

            // Run the test against one instance of the context
            using (var context = new BloggingContext(options))
            {
                var service = new BlogService(context);
                service.Add(&quot;http://sample.com&quot;);
            }

            // Use a separate instance of the context to verify correct data was saved to database
            using (var context = new BloggingContext(options))
            {
                Assert.AreEqual(1, context.Blogs.Count());
                Assert.AreEqual(&quot;http://sample.com&quot;, context.Blogs.Single().Url);
            }
        }

        [TestMethod]
        public void Find_searches_url()
        {
            // All contexts that share the same service provider will share the same InMemory database
            var options = CreateNewContextOptions();

            // Insert seed data into the database using one instance of the context
            using (var context = new BloggingContext(options))
            {
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/cats&quot; });
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/catfish&quot; });
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/dogs&quot; });
                context.SaveChanges();
            }

            // Use a clean instance of the context to run the test
            using (var context = new BloggingContext(options))
            {
                var service = new BlogService(context);
                var result = service.Find(&quot;cat&quot;);
                Assert.AreEqual(2, result.Count());
            }
        }
    }
}
</code></pre><h2 id="sharing-a-database-instance-for-read-only-tests" sourcefile="miscellaneous/testing.md" sourcestartlinenumber="188" sourceendlinenumber="188">Sharing a database instance for read-only tests</h2>
<p sourcefile="miscellaneous/testing.md" sourcestartlinenumber="190" sourceendlinenumber="190">If a test class has read-only tests that share the same seed data, then you can share the InMemory database instance for the whole class (rather than a new one for each method). This means you have a single  <code>DbContextOptions&lt;TContext&gt;</code> and <code>IServiceProvider</code> for the test class, rather than one for each test method.</p>
<!-- [!code-csharp[Main](samples/Miscellaneous/Testing/TestProject/BlogServiceTestsReadOnly.cs)] -->
<pre sourcefile="miscellaneous/testing.md" sourcestartlinenumber="193" sourceendlinenumber="267"><code class="lang-csharp">using Microsoft.VisualStudio.TestTools.UnitTesting;
using Microsoft.Extensions.DependencyInjection;
using BusinessLogic;
using Microsoft.EntityFrameworkCore;
using System.Linq;
using System;

namespace TestProject
{
    [TestClass]
    public class BlogServiceTestsReadOnly
    {
        private DbContextOptions&lt;BloggingContext&gt; _contextOptions;

        public BlogServiceTestsReadOnly()
        {
            // Create a service provider to be shared by all test methods
            var serviceProvider = new ServiceCollection()
                 .AddEntityFrameworkInMemoryDatabase()
                 .BuildServiceProvider();

            // Create options telling the context to use an
            // InMemory database and the service provider.
            var builder = new DbContextOptionsBuilder&lt;BloggingContext&gt;();
            builder.UseInMemoryDatabase()
                   .UseInternalServiceProvider(serviceProvider);

            _contextOptions = builder.Options;

            // Insert the seed data that is expected by all test methods
            using (var context = new BloggingContext(_contextOptions))
            {
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/cats&quot; });
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/catfish&quot; });
                context.Blogs.Add(new Blog { Url = &quot;http://sample.com/dogs&quot; });
                context.SaveChanges();
            }
        }

        [TestMethod]
        public void Find_with_empty_term()
        {
            using (var context = new BloggingContext(_contextOptions))
            {
                var service = new BlogService(context);
                var result = service.Find(&quot;&quot;);
                Assert.AreEqual(3, result.Count());
            }
        }

        [TestMethod]
        public void Find_with_unmatched_term()
        {
            using (var context = new BloggingContext(_contextOptions))
            {
                var service = new BlogService(context);
                var result = service.Find(&quot;horse&quot;);
                Assert.AreEqual(0, result.Count());
            }
        }

        [TestMethod]
        public void Find_with_some_matched()
        {
            using (var context = new BloggingContext(_contextOptions))
            {
                var service = new BlogService(context);
                var result = service.Find(&quot;cat&quot;);
                Assert.AreEqual(2, result.Count());
            }
        }
    }
}
</code></pre>
            </article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/shirhatti/EntityFramework.Docs/blob/export-qa-fixes/ef/miscellaneous/testing.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright Â© 2015-2016 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
